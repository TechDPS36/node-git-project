name: Node Hello World CI/CD + DORA + Datadog

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Instalar dependÃªncias
        run: npm install

      - name: Rodar servidor Node.js (teste bÃ¡sico)
        run: |
          echo "Iniciando aplicaÃ§Ã£o para teste..."
          node server.js &
          sleep 3

      #############################################
      # ðŸ“Œ DORA â€” registrar inÃ­cio do deploy
      #############################################
      - name: Registrar inÃ­cio do deploy
        run: echo "DEPLOY_START=$(date +%s)" >> $GITHUB_ENV

      #############################################
      # ðŸ“Œ Instalar Datadog CLI
      #############################################
      - name: Instalar Datadog CLI
        run: npm install -g @datadog/datadog-ci

      #############################################
      # ðŸ“Œ Enviar DORA Metrics para o Datadog
      #############################################
      - name: Enviar DORA Metrics
        env:
          DD_API_KEY: ${{ secrets.DATADOG_API_KEY }}
          DD_SITE: "datadoghq.com"
        run: |
          datadog-ci dora deployment \
            --service "node-hello-world" \
            --env "dev" \
            --started-at $DEPLOY_START \
            --finished-at $(date +%s) \
            --version "1.0.0" \
            --git-repository-url "${{ github.server_url }}/${{ github.repository }}" \
            --git-commit-sha "${{ github.sha }}" \
            --custom-tags "workflow:node-hello,language:node"

      - name: FinalizaÃ§Ã£o
        run: echo "Pipeline concluÃ­do com monitoramento Datadog + DORA Metrics! ðŸš€"